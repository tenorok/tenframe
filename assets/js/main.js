var core=(function($){var that={},parseUrl=function(path){var url=path.split('/');for(var i=0;i<url.length;i++){if(url[i]===''||url[i]==location.protocol||url[i]==location.hostname){url.splice(i,1);i--;}}
return url;},curLocation,request=function(){if(curLocation==location.href)
return;var firstCall=(curLocation===undefined)?true:false;curLocation=location.href;core.args={};var href=parseUrl(curLocation),routes=core.routes.routes;for(var route=0;route<routes.length;route++){var url=routes[route].url,ctrl=routes[route].ctrl,func=routes[route].func,call=routes[route].call||'ever',rules=routes[route].rules||null,pathArr=[];if(typeof(url)=='string')
pathArr[0]=parseUrl(url);else{for(var p=0;p<url.length;p++)
pathArr[p]=parseUrl(url[p]);}
nextpath:for(var p=0;p<pathArr.length;p++){var path=pathArr[p];if(href.length!=path.length||call=='load'&&!firstCall)
continue nextpath;var args=[];for(var part=0;part<path.length;part++){var arg=/^{(.*)}$/.exec(path[part]);if(arg){var rule;if(rules===null||(rule=rules[arg[1]])===undefined||rule.test(href[part])){core.args[arg[1]]=href[part];args.push(href[part]);}
else{core.args={};continue nextpath;}}
else if(href[part]!=path[part]){core.args={};continue nextpath;}}
var obj=eval(ctrl),method=(obj)?obj[func]:print('Controller "'+ctrl+'" is undefined','error');if(method)
method.apply(obj,args);else if(method===undefined)
print('Function "'+func+'" of controller "'+ctrl+'" is undefined','error');}}},monitor=function(){if(Modernizr.hashchange)
$(window).on('hashchange popstate locchange',request);else
setInterval(request,500);},saveLess=function(){var set=core.routes.settings.saveless||null;if(set&&core.dev){var links=$('link[rel="stylesheet/less"]');var css={},fileKey,fileHref,lessId,tag,lessTags=[];$.each(links,function(key,value){fileKey=$(value).attr('data-file');fileHref=$(value).attr('href');lessId=fileHref.replace(/\//g,'-').slice(1,-5);css[fileKey]=css[fileKey]||'';tag=$('style#less\\:'+lessId);lessTags.push(tag)
css[fileKey]+=tag.html();});var compress=(set.compress===undefined||set.compress)?true:false;$.post('/sys/ajax/less.php',{event:'save_lesscss',css:JSON.stringify(css),path:set.path,compress:compress},function(){for(var t=0;t<lessTags.length;t++)
lessTags[t].remove();});}},print=function(message,type){type=type||'log';var prefix='Framework:';switch(type){case'log':console.log(prefix,message);break;case'error':console.error(prefix,message);break;case'warn':console.warn(prefix,message);break;}
return false;},init=function(){$(function(){saveLess();request();monitor();});return that;};that.locChange=function(func){func();$(window).trigger('locchange');};that.add=function(to,obj){if(obj===undefined){obj=to;to=this;}
for(var key in obj){var crt=create(to,key,obj[key]);if(crt[1])
continue;if(typeof(crt[0])=='object')
this.add(crt[0],obj[key]);}
function create(to,key,val){for(var keyObj in to){if(key==keyObj){if(typeof(val)!='object')
print('"'+key+': '+val+'" - already exist','error');return[to[key],false];}}
return[to[key]=val,true];}};that.addRoute=function(){for(var route in arguments)
core.routes.routes.push(arguments[route]);};return init();}(jQuery));core.add({routes:{settings:{saveless:{path:'/assets/css/'}},routes:[]}});core.dev=true;$.fn.htmlWithParent=function(){return $("<div/>").append($(this).clone()).html();};core.add({text:function(text){if(!(this instanceof core.text))return new core.text(text);this.text=text;core.text.prototype.translitUri=function(){var exchangeLetters={'А':'A','Б':'B','В':'V','Г':'G','Д':'D','Е':'E','Ё':'E','Ж':'J','З':'Z','И':'I','Й':'Y','К':'K','Л':'L','М':'M','Н':'N','О':'O','П':'P','Р':'R','С':'S','Т':'T','У':'U','Ф':'F','Х':'H','Ц':'TS','Ч':'CH','Ш':'SH','Щ':'SCH','Ъ':'','Ы':'YI','Ь':'','Э':'E','Ю':'YU','Я':'YA','а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'e','ж':'j','з':'z','и':'i','й':'y','к':'k','л':'l','м':'m','н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'h','ц':'ts','ч':'ch','ш':'sh','щ':'sch','ъ':'y','ы':'yi','ь':'','э':'e','ю':'yu','я':'ya',' ':'_'},regexp='';for(key in exchangeLetters)
regexp+=key;return this.text.replace(new RegExp('['+regexp+']','g'),function(str){return str in exchangeLetters?exchangeLetters[str]:'';}).toLowerCase();};}});﻿
core.add({mod:{shop:{categories:{block:'%mod-shop-categories',controller:{list:function(){core.mod.shop.categories.list.init();},add:function(){core.mod.shop.categories.add.init();},edit:function(){core.mod.shop.categories.add.init();core.mod.shop.categories.edit.init();}}}}}});core.addRoute({url:['/admin/','/admin/{page}/','/admin/{page}/{tab}'],ctrl:'core.mod.shop.categories.controller',func:'list'},{url:['/admin/modshop/categories/add/','/admin/modshop/categories/{parentid}/addcategory/'],ctrl:'core.mod.shop.categories.controller',func:'add'},{url:'/admin/modshop/categories/{categoryid}/',ctrl:'core.mod.shop.categories.controller',func:'edit'});core.add({mod:{shop:{categories:{add:{fieldHtml:null,init:function(){var that=this;this.block=core.mod.shop.categories.block;this.fieldHtml=$(this.block+'(fielditem)').htmlWithParent();$(this.block+'(catname)').keyup(function(){that.setAlias.call(that,this);});$(this.block+'(fielditem)').find(this.block+'(selectinput){existfield}').change(function(){that.changeExistList.call(that,this);});$(this.block+'(textinput){name}').keyup(function(){that.addField.call(that,this);});$(this.block+'(checkboxinput)').live('change',function(){that.changeClassifier.call(that,this);});$(this.block+'(textinput){right-column}').live('keyup',function(){that.addClassifierValue.call(that,this);});},setAlias:function(input){$(this.block+'(catalias)').val(core.text($(input).val()).translitUri());},changeExistList:function(select){var $select=$(select),labels=$select.parents(this.block+'(fielditem)').find(this.block+'(labelitem)').not(this.block+'(existlist)');if($select.val()!='new'){this.addField.call(this,select);labels.css({'display':'none'});}
else
labels.css({'display':'block'});},addField:function(field){if($(field).bemGetMod('field'))
return;var lastField=$(this.block+'(fielditem)').last();lastField.find(this.block+'(selectinput){existfield}').bemSetMod('field','added');lastField.find(this.block+'(textinput){name}').bemSetMod('field','added');var fieldsCount=$(this.block+'(fieldlist)').children(this.block+'(fielditem)').length,newFieldHtml=this.fieldHtml.replace(/options_0/g,'options_'+fieldsCount),newField=$(newFieldHtml).appendTo(this.block+'(fieldlist)'),that=this;$(newField).find(this.block+'(selectinput){existfield}').change(function(){that.changeExistList.call(that,this);});$(newField).find(this.block+'(textinput){name}').keyup(function(){that.addField.call(that,this);});},changeClassifier:function(checkbox){var $checkbox=$(checkbox),classifier=$checkbox.parents(this.block+'(labellist)').children(this.block+'(hiddenitem)');var hiddenInput=$checkbox.next();if($checkbox.is(':checked')){$(classifier).css({'display':'block'});$(classifier).children(this.block+'(textinput)').focus();$(hiddenInput).attr('value','1');}
else{$(classifier).css({'display':'none'});$(hiddenInput).attr('value','0');}},addClassifierValue:function(field){var $field=$(field);if($field.bemGetMod('added'))
return;var parent=$field.parent(this.block+'(labelitem)'),valCount=parent.children(this.block+'(textinput)').length,newValueHtml=$($field.htmlWithParent()).attr('placeholder','Значение '+(++valCount)),newValue=newValueHtml.appendTo(parent),that=this;$field.bemSetMod('added','yes');$(newValue).keyup(function(){that.addClassifierValue.call(that,this);});}}}}}});core.add({mod:{shop:{categories:{edit:{init:function(){var that=this;this.block=core.mod.shop.categories.block;$(this.block+'(link){change-parent}').click(function(){return that.toggleParentForm.call(that,this);});$(this.block+'(cat){edit}').click(function(){return that.changeParent.call(that,this);});},toggleParentForm:function(link){var arrow=$(link).children(this.block+'(harr)');$(this.block+'(list){edit}').slideToggle(200,function(){if($(this).is(':hidden'))
arrow.html('&#9650;');else
arrow.html('&#9660;');});return false;},changeParent:function(category){var $category=$(category);if($category.bemGetMod('selected')){$category.bemDelMod('selected');$(this.block+'(catparent)').attr('value','');}
else{$(this.block+'(cat){edit}').bemDelMod('selected');$category.bemSetMod('selected','yes');$(this.block+'(catparent)').attr('value',$category.attr('href'));}
return false;}}}}}});core.add({mod:{shop:{categories:{list:{init:function(){var that=this;this.block=core.mod.shop.categories.block;$(this.block+'(cat)').click(function(){return that.showDropdown.call(that,this);});$(document).click(function(){that.hideDropdown.call(that);});this.drawHarr();this.sortable();},showDropdown:function(link){var $link=$(link),position=$link.position(),top=position.top,left=position.left,href=$link.attr('href'),dropdown=this.block+'(dropdown-menu)';$(this.block+'(dropdown)').css({'display':'block','top':top+29,'left':left-8});$(dropdown+'{add-product}').attr({'href':href+'addproduct'});$(dropdown+'{add-category}').attr({'href':href+'addcategory'});$(dropdown+'{edit}').attr({'href':href});return false;},hideDropdown:function(){$(this.block+'(dropdown)').css({'display':'none'});},drawHarr:function(){var arrow='<span class="'+this.block.substr(1)+'__harr">&#9660;</span>';$(this.block+'(item):has('+this.block+'(item))').children(this.block+'(name)').append(arrow);var that=this;$(this.block+'(harr)').click(function(){that.slideCategoryList.call(that,this);});},slideCategoryList:function(arrow){var arrow=$(arrow);arrow.parent().next(this.block+'(list)').slideToggle(200,function(){if($(this).is(':hidden'))
arrow.html('&#9650;');else
arrow.html('&#9660;');});},sortable:function(){var that=this;$(this.block+'(list)').disableSelection().sortable({start:function(e,ui){$(ui.placeholder).hide(300);},change:function(e,ui){$(ui.placeholder).hide().show(300);},tolerance:'pointer',update:function(data){that.serializeList.call(that,data);},handle:this.block+'(draggable)',axis:'y',containment:'parent'});},serializeList:function(data){var items=$(data.target).children(this.block+'(item)');var arr=[];$.each(items,function(){var id=$(this).attr('id').split('_')[1];arr.push(id);});$.ajax({type:'GET',url:'/mod/shop/app/ajax/categories.php',data:{event:'sort',categories:arr},dataType:'json'});}}}}}});